<html>

<head>
    <meta charset="utf-8">
    <title>HW provider example</title>
    <style>
        button {
            margin-top: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <div>
        <button onclick="init()">Initialize</button>
    </div>
    <div>
        <input value="0" type="number" min="0" name="addressIndexForLogin" />
        <button onclick="login()">Login</button>
    </div>
    <div>
        <input value="0" type="number" min="0" name="addressIndexForSetAddress" />
        <button onclick="setAddressIndex()">Set address index</button>
    </div>
    <div>
        <button onclick="signTransaction()">Sign transaction</button>
    </div>

    <script src="../out-examples/lib.js"></script>
    <script>
        var provider = new lib.HWProvider();

        async function init() {
            await provider.init();
            console.log("Initialized.");
        }

        async function login() {
            var addressIndex = parseInt(document.getElementsByName("addressIndexForLogin")[0].value);
            console.log("Login with addressIndex", addressIndex);
            await provider.login({ addressIndex: addressIndex });
            await logAddresses();
        }

        async function logAddresses() {
            let addresses = await provider.getAccounts();
            let currentAddress = await provider.getAddress();

            console.log("Addresses:", addresses);
            console.log("Current address:", currentAddress);
        }

        async function setAddressIndex() {
            var addressIndex = parseInt(document.getElementsByName("addressIndexForSetAddress")[0].value);
            console.log("Set addressIndex", addressIndex);
            await provider.setAddressIndex(addressIndex);
            await logAddresses();
        }

        async function signTransaction() {
            let transaction = new DummyTransaction();
            await provider.signTransaction(transaction);

            console.log("Done!");
        }

        function DummyTransaction() {
            // These will be set by hwProvider before calling serializeForSigning().
            this.version = {};
            this.options = {};

            this.serializeForSigning = function (signedBy) {
                console.log("DummyTransaction.serializeForSigning()", signedBy.bech32());
                console.log("Transaction version", this.version);
                console.log("Transaction options", this.options);

                let json = JSON.stringify({
                    nonce: 0,
                    value: "1",
                    receiver: "erd1uv40ahysflse896x4ktnh6ecx43u7cmy9wnxnvcyp7deg299a4sq6vaywa",
                    sender: signedBy.bech32(),
                    gasPrice: 1000000000,
                    gasLimit: 50000,
                    data: btoa("hello"),
                    chainID: "1",
                    version: this.version.valueOf(),
                    options: this.options.valueOf()
                });

                console.log("Serialized transaction:");
                console.log(json);
                return json;
            };

            this.applySignature = function (signature, signedBy) {
                console.log("DummyTransaction.applySignature()", signature.hex(), signedBy.bech32());
            }
        }
    </script>
</body>

</html>
